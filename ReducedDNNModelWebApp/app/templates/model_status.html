{% extends 'base.html' %}

{% block title %}Model Status - DNN Classifier{% endblock %}

{% block content %}
<div class="status-container">
    <div class="status-header">
        <h1>Model Status</h1>
    </div>

    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>Loading model information...</p>
    </div>

    <div id="errorMessage" class="error-banner" style="display: none;">
        <span class="error-icon">âš </span>
        <span id="errorText"></span>
    </div>

    <div id="statusContent" style="display: none;">
        <!-- Models Grid -->
        <div class="models-grid">
            <!-- Heavy Model Card -->
            <div class="model-card" id="heavyModelCard">
                <div class="model-header">
                    <div class="model-icon">ðŸ”¥</div>
                    <div>
                        <h2 id="heavyModelName">Heavy Model</h2>
                        <span class="model-label">High Accuracy</span>
                    </div>
                </div>
                <div class="status-badge" id="heavyStatus"></div>
                
                <!-- Model Info -->
                <div class="model-info">
                    <div class="info-item">
                        <span class="info-label">ðŸ“¦ Model Size:</span>
                        <span class="info-value" id="heavySize">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ðŸŽ¯ CIFAR-10 Test Accuracy:</span>
                        <span class="info-value" id="heavyAccuracy">--</span>
                    </div>
                </div>

                <!-- Performance Table -->
                <div class="performance-section">
                    <h3>Performance Metrics</h3>
                    <table class="performance-table" id="heavyPerformanceTable">
                        <thead>
                            <tr>
                                <th>Batch Size</th>
                                <th>Inference Time (ms)</th>
                                <th>Throughput (samples/sec)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Light Model Card -->
            <div class="model-card" id="lightModelCard">
                <div class="model-header">
                    <div class="model-icon">âš¡</div>
                    <div>
                        <h2 id="lightModelName">Light Model</h2>
                        <span class="model-label">Fast Inference</span>
                    </div>
                </div>
                <div class="status-badge" id="lightStatus"></div>
                
                <!-- Model Info -->
                <div class="model-info">
                    <div class="info-item">
                        <span class="info-label">ðŸ“¦ Model Size:</span>
                        <span class="info-value" id="lightSize">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ðŸŽ¯ CIFAR-10 Test Accuracy:</span>
                        <span class="info-value" id="lightAccuracy">--</span>
                    </div>
                </div>

                <!-- Performance Table -->
                <div class="performance-section">
                    <h3>Performance Metrics</h3>
                    <table class="performance-table" id="lightPerformanceTable">
                        <thead>
                            <tr>
                                <th>Batch Size</th>
                                <th>Inference Time (ms)</th>
                                <th>Throughput (samples/sec)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function fetchModelStatus() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const statusContent = document.getElementById('statusContent');

        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        statusContent.style.display = 'none';

        fetch('/api/model-status/')
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';

                if (data.success) {
                    statusContent.style.display = 'block';
                    updateModelCard('heavy', data.models.heavy);
                    updateModelCard('light', data.models.light);
                } else {
                    showError(data.error || 'Failed to fetch model status');
                }
            })
            .catch(error => {
                loadingIndicator.style.display = 'none';
                showError('Network error: ' + error.message);
            });
    }

    function updateModelCard(modelType, modelInfo) {
        const card = document.getElementById(modelType + 'ModelCard');
        const statusBadge = document.getElementById(modelType + 'Status');
        const nameElement = document.getElementById(modelType + 'ModelName');
        const sizeElement = document.getElementById(modelType + 'Size');
        const accuracyElement = document.getElementById(modelType + 'Accuracy');
        const performanceTable = document.getElementById(modelType + 'PerformanceTable');

        // Remove all status classes
        card.classList.remove('available', 'unavailable');
        statusBadge.classList.remove('available', 'unavailable');

        // Update model name
        nameElement.textContent = modelInfo.name + ' Model';

        if (modelInfo.exists) {
            // Model file exists
            card.classList.add('available');
            statusBadge.classList.add('available');
            statusBadge.textContent = 'âœ“ Available';
            
            // Update size
            sizeElement.textContent = modelInfo.size_mb + ' MB';
            
            // Update CIFAR-10 accuracy
            if (modelInfo.cifar10_accuracy !== null) {
                accuracyElement.textContent = modelInfo.cifar10_accuracy + '%';
            } else {
                accuracyElement.textContent = '--';
            }

            // Populate performance table
            const tbody = performanceTable.querySelector('tbody');
            tbody.innerHTML = ''; // Clear existing rows
            
            if (modelInfo.batch_metrics && modelInfo.batch_metrics.length > 0) {
                modelInfo.batch_metrics.forEach(metric => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="batch-size-cell">${metric.batch_size}</td>
                        <td>${metric.inference_time} ms</td>
                        <td>${metric.throughput} samples/sec</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="3">No performance data available</td></tr>';
            }
        } else {
            // Model file not found
            card.classList.add('unavailable');
            statusBadge.classList.add('unavailable');
            statusBadge.textContent = 'âœ— Not Found';
            
            sizeElement.textContent = '--';
            accuracyElement.textContent = '--';
            
            const tbody = performanceTable.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="3">Model not available</td></tr>';
        }
    }

    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        errorText.textContent = message;
        errorMessage.style.display = 'flex';
    }

    // Load status on page load
    document.addEventListener('DOMContentLoaded', fetchModelStatus);
</script>
{% endblock %}
